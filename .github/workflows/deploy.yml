name: Deploy OpenClaw Instance

on:
  workflow_dispatch:
    inputs:
      instance_name:
        description: 'Worker instance name (e.g. moltbot-sandbox, my-assistant)'
        required: true
        default: 'moltbot-sandbox'
      sleep_after:
        description: 'Container sleep timeout (e.g. 10m, 1h, never)'
        required: false
        default: '10m'
      telegram_token:
        description: 'Telegram bot token (optional)'
        required: false
        default: ''
      gateway_token:
        description: 'Gateway token (leave empty to auto-generate)'
        required: false
        default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Update Dockerfile to latest OpenClaw
        run: sed -i 's/openclaw@[^ ]*/openclaw@latest/' Dockerfile

      - name: Patch worker name
        run: |
          WORKER="${{ github.event.inputs.instance_name }}"
          sed -i "s/\"name\": \"moltbot-sandbox\"/\"name\": \"${WORKER}\"/" wrangler.jsonc
          # Also patch R2 bucket name for unique instances
          sed -i "s/\"bucket_name\": \"moltbot-data\"/\"bucket_name\": \"${WORKER}-data\"/" wrangler.jsonc

      - name: Generate tokens
        id: tokens
        run: |
          if [ -n "${{ github.event.inputs.gateway_token }}" ]; then
            GATEWAY_TOKEN="${{ github.event.inputs.gateway_token }}"
          else
            GATEWAY_TOKEN=$(openssl rand -hex 32)
          fi
          CDP_SECRET=$(openssl rand -hex 32)
          echo "gateway_token=$GATEWAY_TOKEN" >> $GITHUB_OUTPUT
          echo "cdp_secret=$CDP_SECRET" >> $GITHUB_OUTPUT

      - name: Deploy to Cloudflare
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: npx wrangler deploy

      - name: Set worker secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          WORKER="${{ github.event.inputs.instance_name }}"
          
          echo "${{ secrets.ANTHROPIC_API_KEY }}" | npx wrangler secret put ANTHROPIC_API_KEY --name "$WORKER"
          echo "${{ steps.tokens.outputs.gateway_token }}" | npx wrangler secret put MOLTBOT_GATEWAY_TOKEN --name "$WORKER"
          echo "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" | npx wrangler secret put CF_ACCOUNT_ID --name "$WORKER"
          echo "${{ secrets.CF_ACCESS_TEAM_DOMAIN }}" | npx wrangler secret put CF_ACCESS_TEAM_DOMAIN --name "$WORKER"
          echo "${{ github.event.inputs.sleep_after }}" | npx wrangler secret put SANDBOX_SLEEP_AFTER --name "$WORKER"
          echo "true" | npx wrangler secret put DEBUG_ROUTES --name "$WORKER"
          echo "${{ steps.tokens.outputs.cdp_secret }}" | npx wrangler secret put CDP_SECRET --name "$WORKER"
          echo "https://${WORKER}.tomescnt100.workers.dev" | npx wrangler secret put WORKER_URL --name "$WORKER"
          
          if [ -n "${{ github.event.inputs.telegram_token }}" ]; then
            echo "${{ github.event.inputs.telegram_token }}" | npx wrangler secret put TELEGRAM_BOT_TOKEN --name "$WORKER"
          fi

      - name: Set Cloudflare Access AUD
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          WORKER="${{ github.event.inputs.instance_name }}"
          AUD=$(curl -s "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/access/apps" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" | \
            jq -r ".result[] | select(.domain == \"${WORKER}.tomescnt100.workers.dev\") | .aud" | head -1)
          
          if [ -n "$AUD" ] && [ "$AUD" != "null" ]; then
            echo "$AUD" | npx wrangler secret put CF_ACCESS_AUD --name "$WORKER"
            echo "✅ CF_ACCESS_AUD set"
          else
            echo "⚠️ No Access app found — create one in Zero Trust → Access → Applications"
          fi

      - name: Write deployment summary
        run: |
          WORKER="${{ github.event.inputs.instance_name }}"
          TOKEN="${{ steps.tokens.outputs.gateway_token }}"
          CDP="${{ steps.tokens.outputs.cdp_secret }}"
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ✅ OpenClaw Instance Deployed
          
          | Field | Value |
          |-------|-------|
          | **Instance** | \`${WORKER}\` |
          | **URL** | https://${WORKER}.tomescnt100.workers.dev/?token=${TOKEN} |
          | **Admin** | https://${WORKER}.tomescnt100.workers.dev/_admin/ |
          | **Gateway Token** | \`${TOKEN}\` |
          | **CDP Secret** | \`${CDP}\` |
          | **Sleep After** | ${{ github.event.inputs.sleep_after }} |
          | **Telegram** | ${{ github.event.inputs.telegram_token && '✅ Configured' || '❌ Not set' }} |
          EOF
